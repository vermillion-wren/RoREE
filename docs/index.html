<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RoREE - Risk of Rain Electronic Encyclopedia</title>
    <link rel="icon" type="image/x-icon" href="favicon.png">
    <link rel="stylesheet" href="styles.css">

    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
</head>

<body>
    <div class="header">
        <img src="favicon.png" />
        <h1>RoREE</h1>
        <h2>Your Risk of Rain Electronic Encyclopedia</h2>
    </div>
    <br />
    

    <!-- Settings -->

    <fieldset>
        <legend> Output Settings: </legend>

        <details>
            <summary>Columns To Display</summary>
            <input type="checkbox" id="showID" name="columnOptions" value="id">
            <label for="showID">Item ID</label>
            <br>
            <input type="checkbox" id="showIcons" name="columnOptions" value="imageLink" checked>
            <label for="showID">Item Icon</label>
            <br>
            <input type="checkbox" id="showName" name="columnOptions" value="name" checked>
            <label for="showName">English Name</label>
            <br>
            <input type="checkbox" id="showRainglish" name="columnOptions" value="rainglish" checked>
            <label for="showRainglish">Rainglish Name</label>
            <br>
            <input type="checkbox" id="showRarity" name="columnOptions" value="rarity" checked>
            <label for="showRarity">Rarity</label>
            <br>
            <input type="checkbox" id="showType" name="columnOptions" value="type">
            <label for="showType">Item Type</label>
            <br>
            <input type="checkbox" id="showTag" name="columnOptions" value="tag">
            <label for="showTag">Item Tag</label>
            <br>
            <input type="checkbox" id="showStack" name="columnOptions" value="stack">
            <label for="showStack">Stacking Type</label>
            <br>
            <input type="checkbox" id="showDescription" name="columnOptions" value="description" checked>
            <label for="showDescription">Effect Description</label>
            <br>
            <input type="checkbox" id="showUnlock" name="columnOptions" value="unlock">
            <label for="showUnlock">Unlock Condition</label>
            <br>
        </details>

        <hr />

        <label for="showQuery">Show generated query?</label>
        <input type="checkbox" id="showQuery" name="showQuery" />

    </fieldset>
    <br />

    <!-- Query Maker -->
    <fieldset>
        <legend> Query an item: </legend>
        <!-- Item Name-->
        <label for="itemName">Search for</label>
        <input type="text" id="itemName" placeholder="Name">

        <!-- Item Rarity -->
        <label for="itemRarity">with</label>
        <select id="itemRarity" name="rarity">
            <option value="all">Any</option>
            <option value="Common">Common</option>
            <option value="Uncommon">Uncommon</option>
            <option value="Legendary">Legendary</option>
            <option value="Boss">Boss</option>
            <option value="Void">Void</option>
            <option value="Lunar">Lunar</option>
        </select>
        <label for="itemRarity">rarity </label>

        <!-- Description Keywords -->
        <label for="descriptionKeywords">and </label>
        <input type="text" id="descriptionKeywords" placeholder="keyword">
        <label for="descriptionKeywords"> in description</label>
        <hr />

        <!-- Less Important Filters -->
        <details>
            <summary>More Filters</summary>
            <label for="itemType">Item Type: </label>
            <select id="itemType" name="type">
                <option value="all">Any</option>
                <option value="damage">Damage</option>
                <option value="utility">Utility</option>
                <option value="equipment">Equipment</option>
                <option value="-">None</option>
            </select>
            <br />

            <label for="itemStacking">Stacking Type: </label>
            <select id="itemStacking" name="stacking">
                <option value="all">Any</option>
                <option value="none">None</option>
                <option value="linear">Linear</option>
                <option value="exponential">Exponential</option>
                <option value="hyperbolic">Hyperbolic</option>
                <option value="unique">Unique</option>
            </select>
            <br />

            <label for="checkTags">Check Item Tags for instances of Name?</label>
            <input type="checkbox" id="checkTags" name="checkTags" />

        </details>

        <button onclick="queryByFilters()">Search</button>
        <button onclick="returnToDefault()">Reset Filters</button>
    </fieldset>
    <br />

    <div id="query-display"></div>
    <div id="query-report"></div>
    <br />
    <div id="query-output"></div>

    <script>
        columns = ['image', 'id', 'rarity', 'name', 'rainglish', 'type', 'tag', 'stack', 'description', 'unlock'];
        headerNames = {
            "image": "Icon",
            "id": "Item ID",
            "rarity": "Rarity",
            "name": "Name",
            "rainglish": "Rainglish Name",
            "type": "Item Type",
            "tag": "Item Tag",
            "stack": "Stacking Type",
            "description": "Effect Description",
            "unlock": "Unlock Condition",
            "imageLink": "Icon"
        };

        // Database management
        class DatabaseManager {
            constructor(dbPath) {
                this.dbPath = dbPath;
                this.db = null;
            }

            async init() {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${file}`
                });

                const response = await fetch(this.dbPath);
                const buffer = await response.arrayBuffer();
                this.db = new SQL.Database(new Uint8Array(buffer));
            }

            query(sqlQuery) {
                var logDiv = document.getElementById("query-display");
                if (document.getElementById("showQuery").checked) {
                    logDiv.innerText = "Query: " + sqlQuery;
                } else {
                    logDiv.innerText = "";
                }
                return this.db.exec(sqlQuery);
            }
        }

        // Visualization manager
        class VisualizationManager {
            displayTable(queryResult, outputDiv, report) {
                if (queryResult.length > 0) {
                    if (report) {
                        document.getElementById('query-report').innerText = "Found " + queryResult[0].values.length + " items matching your filters!";
                    }
                    const rows = queryResult[0].values;
                    const headers = queryResult[0].columns;

                    const table = document.createElement('table');
                    const headerRow = table.insertRow();
                    headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = headerNames[header];
                        th.setAttribute("style", "background-color:#1f1a66");
                        headerRow.appendChild(th);
                    });

                    const regex = /https:\/\//;

                    rows.forEach(row => {
                        const tr = table.insertRow();
                        row.forEach(cell => {
                            const td = tr.insertCell();

                            if (regex.test(cell)) {
                                td.innerHTML = "<img src=" + cell + ">";
                            } else {
                                td.textContent = cell;

                                switch (cell) {
                                    case "Common":
                                        td.setAttribute("style", "background-color:#aaaaaa");
                                        break;
                                    case "Uncommon":
                                        td.setAttribute("style", "background-color:#00ff66");
                                        break;
                                    case "Legendary":
                                        td.setAttribute("style", "background-color:#ff0033");
                                        break;
                                    case "Lunar":
                                        td.setAttribute("style", "background-color:#0066ff");
                                        break;
                                    case "Boss":
                                        td.setAttribute("style", "background-color:#ffff00");
                                        break;
                                    case "Void":
                                        td.setAttribute("style", "background-color:#c678b4");
                                        break;
                                    case "Equipment":
                                        td.setAttribute("style", "background-color:#ff6633");
                                        break;
                                }
                            }
                        });
                    });

                    outputDiv.innerHTML = '';
                    outputDiv.appendChild(table);

                    return rows;
                }
                if (report) {
                    outputDiv.textContent = 'No results found for these filters. Maybe try another query?';
                }
                return null;
            }
        }

        // Global instance of the DatabaseManager
        const dbManager = new DatabaseManager('https://raw.githubusercontent.com/vermillion-wren/RoREE/refs/heads/main/docs/sqlite/withImages.sqlite');
        const visManager = new VisualizationManager();

        document.addEventListener('DOMContentLoaded', async () => {
            await dbManager.init();
            console.log("Database initialized.");

            const initialQuery = `SELECT imageLink, name, rainglish, rarity, description FROM "itemList"`;
            visManager.displayTable(dbManager.query(initialQuery), document.getElementById('query-output'), false);
        });

        // Event handlers
        function returnToDefault() {
            var name = document.getElementById('itemName');
            var checkTagsAlso = document.getElementById('checkTags');

            var rarity = document.getElementById('itemRarity');
            var keyword = document.getElementById('descriptionKeywords');
            var type = document.getElementById('itemType');
            var stacking = document.getElementById('itemStacking');

            name.value = name.defaultValue;
            checkTagsAlso.checked = false;
            rarity.value = "all";
            keyword.value = keyword.defaultValue;
            type.value = "all";
            stacking.value = "all";
        }

        async function queryByFilters() {
            document.getElementById('query-report').innerText = "";
            document.getElementById('query-output').innerHTML = "";

            try {
                var columnChecklist = document.querySelectorAll('input[name="columnOptions"]:checked');
                var selectedCheckboxes = Array.from(columnChecklist).map(checkbox => checkbox.value);

                if (selectedCheckboxes.length == 0) {
                    document.getElementById('query-report').textContent = 'No columns selected. What are you trying to see?';
                    return;
                }

                var columnsToShow = selectedCheckboxes.join(", ");

                // -----------------------------------------------
                const name = document.getElementById('itemName').value;
                const checkTagsAlso = document.getElementById('checkTags').checked;

                const rarity = document.getElementById('itemRarity').value;
                const keyword = document.getElementById('descriptionKeywords').value;
                const type = document.getElementById('itemType').value;
                const stacking = document.getElementById('itemStacking').value;

                const clauses = [];

                // -----------------------------------------------
                if (name != "") {
                    if (checkTagsAlso) {
                        clauses.push(`(name LIKE '%${name}%' OR rainglish LIKE '%${name}%' or tag LIKE '%${name}%')`);
                    } else {
                        clauses.push(`(name LIKE '%${name}%' OR rainglish LIKE '%${name}%')`);
                    }
                }

                if (rarity != "all") {
                    clauses.push(`rarity = '${rarity}'`);
                }

                if (keyword != "") {
                    clauses.push(`description LIKE '%${keyword}%'`)
                }

                if (type != "all") {
                    clauses.push(`type = '${type}'`);
                }

                if (stacking != "all") {
                    clauses.push(`stack = '${stacking}'`)
                }

                // -----------------------------------------------
                var query = `SELECT ${columnsToShow} FROM "itemList"`;

                var firstClause = true;
                for (const clause of clauses) {
                    if (firstClause) {
                        query = query + " WHERE " + clause;
                        firstClause = false;
                    } else {
                        query = query + " AND " + clause;
                    }
                }

                const queryResult = dbManager.query(query);
                const rows = visManager.displayTable(queryResult, document.getElementById('query-output'), true);
            } catch (error) {
                console.error('Error querying the database:', error);
                document.getElementById('query-report').textContent = 'An error occurred while querying the database.';
            }
        }

    </script>
</body>
</html>